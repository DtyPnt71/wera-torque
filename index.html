<!DOCTYPE html>

<html lang="de">
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="icon-192.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
    <link rel="shortcut icon" href="icon-192.png" type="image/png">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Drehmomentkorrektur WERA</title>
<link href="manifest.json" rel="manifest"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="styles.css" rel="stylesheet"/>
</head>
<body class="dark">

  <div id="boot-overlay" class="boot-overlay" aria-live="polite" style="display:none">
    <div class="boot-card">
      <div class="boot-brand" aria-hidden="true">WERA Torque</div>
      <div class="spinner" aria-hidden="true"></div>
      <h2 id="boot-title">Update</h2>
      <div class="boot-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="boot-progress-bar" class="boot-progress-bar"></div>
      </div>
      <p id="boot-status">Initialisiere‚Ä¶</p>
      <div id="boot-details" class="boot-details" aria-label="Statusdetails"></div>
      <div id="boot-actions" class="boot-actions" style="display:none">
        <button id="boot-retry" class="btn">Neu laden</button>
        <button id="boot-update" class="btn primary">Update</button>
        <button id="boot-later" class="btn ghost">Sp√§ter</button>
      </div>
    </div>
  </div>

  <div id="maintenanceOverlay" class="maintenance-overlay" role="status" aria-live="polite">
    <div class="maintenance-card">
      <div class="maintenance-gear" aria-hidden="true"></div>
      <div class="maintenance-title">Wartungsarbeiten / Maintenance</div>
      <p class="maintenance-text"><strong>DE:</strong> Derzeit werden Wartungsarbeiten durchgef√ºhrt. Bitte versuchen Sie es sp√§ter erneut.</p>
      <p class="maintenance-text"><strong>EN:</strong> We are currently performing maintenance. Please try again later.</p>
      <button id="maintenanceReload" class="btn primary" type="button">Neu laden</button>
    </div>
  </div>
  <script>
    (function(){
      function enableMaintenance(){
        document.body.classList.add('is-maintenance');
        var btn = document.getElementById('maintenanceReload');
        if (btn && !btn.__bound){
          btn.__bound = true;
          btn.addEventListener('click', function(){ location.reload(); });
        }
      }
      async function checkMaintenance(){
        try{
          var r = await fetch('manifest.json', { cache: 'no-store' });
          var m = await r.json();
          if (m && m.maintenance === true) enableMaintenance();
        }catch(e){}
      }
      checkMaintenance();
      // also re-check when coming back online
      window.addEventListener('online', checkMaintenance);
    })();
  </script>


<div class="app-shell">

<div class="animated-intro" id="intro" aria-hidden="true">
  <div class="intro-card" role="status" aria-live="polite">
    <div class="intro-mark" aria-hidden="true">W</div>
    <h2>Drehmomentkorrektur</h2>
    <p>Tool wird gestartet‚Ä¶</p>
    <div class="intro-progress" aria-hidden="true"><span></span></div>
  </div>
</div>

<main class="container">
  <header class="app-header">
    <div class="brand">
      <img class="brand-logo" src="icon-192.png" alt="WERA" />
      <div class="brand-text">
        <div class="brand-title" id="title">Drehmomentkorrektur WERA</div>
        <div class="brand-subtitle">Tool</div>
      </div>
    </div>

    <div class="toolbar" role="group" aria-label="Aktionen">
      <button id="table-btn" class="btn-ghost" onclick="openTableModal()">üìã Tabelle</button>
      <button id="langBtn" class="btn-ghost" onclick="switchLanguage()">üåê Sprache: DE</button>
      <button class="btn-ghost" onclick="toggleTheme()">üåì Dark/Light</button>
      <button id="install-btn" class="btn-primary" style="display:block;">üì≤ Installieren</button>
      <button class="btn-ghost" id="changelog-btn" onclick="showChangelog()">üìã Changelog</button>
    </div>
  </header>

  <section class="card form-section">
    <div class="field">
      <label for="insertType">Werkzeugeinsatz</label>
      <div class="select">
        <select id="insertType">
<option value="">-- ausw√§hlen --</option>
<option value="Joker L">Joker L (14x18)</option>
<option value="Joker XL">Joker XL (14x18)</option>
<option value="Joker XXL">Joker XXL (14x18)</option>
<option value="Joker 3XL">Joker 3XL (14x18)</option>
        </select>
        <span class="chev" aria-hidden="true"></span>
      </div>
    </div>

    <div class="field">
      <label for="sw">Schl√ºsselweite</label>
      <div class="select">
        <select disabled="" id="sw">
<option value="">-- zuerst Werkzeugeinsatz w√§hlen --</option>
        </select>
        <span class="chev" aria-hidden="true"></span>
      </div>
    </div>

    <div class="field">
      <label for="keyType">Drehmomentschl√ºssel</label>
      <div class="select">
        <select id="keyType">
<option value="">-- ausw√§hlen --</option>
<option value="X4">WERA X4 (40‚Äì200 Nm)</option>
<option value="X7">WERA X7 (20‚Äì100 Nm)</option>
        </select>
        <span class="chev" aria-hidden="true"></span>
      </div>
    </div>

    <div class="field">
      <label for="ma">Drehmoment in Nm</label>
      <input id="ma" min="0" type="number" inputmode="decimal" />
    </div>
  </section>

  <section class="card action-section">
    <button class="btn-primary calculate-btn" id="calculate-btn" onclick="calculate()">Jetzt berechnen</button>
    <button class="btn-ghost reset-btn" id="reset-btn" onclick="resetFields()">Zur√ºcksetzen</button>
    <div class="loader-bar" id="loader" style="display: none;"></div>
  </section>

  <section class="card result-section" aria-live="polite">
    <span class="result-label">Ergebnis</span>
    <span class="value-chip" id="result">‚Äì</span>
  </section>

  <section class="card warning-section">
    <div class="warning">
      <div class="warning-title">‚ö†Ô∏è Hinweis</div>
      <div class="warning-text">Bitte nutze nur Werte innerhalb der zul√§ssigen Bereiche ‚Äì au√üerhalb der Spezifikation sind Sch√§den m√∂glich.</div>
      <details class="warning-details">
        <summary>Mehr Informationen</summary>
        <div class="warning-details-body">
          Werkzeugeinsatzl√§nge, Ausschwenkwinkel (bei variabler Schl√ºsselweite) sowie der effektive Hebelarm beeinflussen das Messergebnis ma√ügeblich ‚Äì daher kann eine Korrektur erforderlich sein.
          <br/><br/>
          Die Verwendung dieses Tools erfolgt ausschlie√ülich auf eigenes Risiko; f√ºr daraus resultierende Sch√§den wird keinerlei Haftung √ºbernommen.
        </div>
      </details>
    </div>
  </section>

  <footer class="card footer">
    <div class="footer-row">
      <div>Version wird geladen‚Ä¶</div>
      <div>Erstellt durch Timo Burian</div>
    </div>
    <div class="footer-row footer-small">¬© 2025 ‚Äì Nutzung nur unter <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noreferrer">CC BY-NC-ND 4.0</a></div>

    <div id="visitor-counter" class="visitor-counter" aria-label="Besucherz√§hler">
      <span class="visitor-eye" aria-hidden="true">üëÅÔ∏è</span>
      <span class="visitor-label">Besuche</span>
      <span id="counter-value" class="visitor-pill">‚Äì</span>
    </div>
  </footer>

</main>
<div class="modal" id="modalChangelog" onclick="this.style.display='none'">
<div class="modal-content">
<div id="modalChangelogText" style="max-height: 60vh; overflow-y: auto;"></div>
<button class="modal-close-btn" onclick="document.getElementById('modal').style.display='none'">Schlie√üen</button></div>
</div>
<script>const sizes = {
      "Joker L": { "16": 44.6, "17": 46.7, "18": 48.2, "19": 49.1 },
      "Joker XL": { "19": 51.6, "20": 53.6, "21": 55.4, "22": 56.7, "23": 56.7, "24": 56.7 },
      "Joker XXL": { "24": 62.2, "27": 68, "30": 70.2, "32": 70.4 },
      "Joker 3XL": { "32": 77, "34": 79, "36": 80, "41": 81.5 }
    };

    const data = {
      X4: { Lk: 435, Sk: 25.5, min: 40, max: 200 },
      X7: { Lk: 343, Sk: 25.5, min: 20, max: 100 }
    };

    document.getElementById("insertType").addEventListener("change", function () {
      const type = this.value;
      const sw = document.getElementById("sw");
      sw.innerHTML = '';
      if (!sizes[type]) {
        sw.disabled = true;
        sw.innerHTML = '<option value="">-- zuerst Werkzeugeinsatz w√§hlen --</option>';
        return;
      }
      sw.disabled = false;
      sw.innerHTML = '<option value="">-- ausw√§hlen --</option>';
      Object.keys(sizes[type]).forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = `SW ${val}`;
        sw.appendChild(opt);
      });
    });

    function showModal(txt) {
      document.getElementById("modalText").innerText = txt;
      document.getElementById("modal").style.display = "block";
    }

    function showAddToHome() {
      showModal("üì≤ So f√ºgst du die App zum Startbildschirm hinzu:\n\nüì± Android: Men√º > 'Zum Startbildschirm hinzuf√ºgen'\nüçè iOS: Teilen-Symbol > 'Zum Homebildschirm'");
    }

    function calculate() {
      const insert = document.getElementById("insertType").value;
      const sw = document.getElementById("sw").value;
      const key = document.getElementById("keyType").value;
      const ma = parseFloat(document.getElementById("ma").value);
      const resultDiv = document.getElementById("result");
      resultDiv.innerText = "";

      if (!insert || !sw || !key || isNaN(ma)) {
        showModal("Bitte f√ºlle alle Felder korrekt aus.");
        return;
      }

      const S = sizes[insert][sw];
      const { Sk, Lk, min, max } = data[key];
      const Ms = ma * Lk / (Lk + (S - Sk));
      const rounded = Math.round(Ms * 100) / 100;

      if (rounded < min || rounded > max) {
        showModal(`Das Ergebnis (${rounded} Nm) liegt au√üerhalb des Bereichs vom WERA ${key}.`);
      }

      resultDiv.innerText = `korrigierter Wert: ${rounded} Nm`;
    }

    function showChangelog() {
      fetch("https://raw.githubusercontent.com/DtyPnt71/wera-torque/main/README.md")
        .then(response => response.text())
        .then(data => {
          document.getElementById("modalChangelogText").innerHTML = marked.parse(data);
          document.getElementById("modalChangelog").style.display = "block";
        })
        .catch(() => {
          alert("Changelog konnte nicht geladen werden.");
        });
    }
  </script>
<script src="install.js"></script>
<script>
fetch('./version.json')
  .then(res => res.json())
  .then(data => {
    const footer = document.querySelector('footer');
    if (footer) {
      footer.querySelector('div').innerText = 'Version ' + data.version;
    }
  })
  .catch(() => {
    console.warn('Version konnte nicht geladen werden.');
  });
</script>
<script src="script.js"></script>
<div class="modal" id="modal">
<div class="modal-content">
<span class="close" onclick="document.getElementById('modal').style.display='none'">√ó</span>
<h2>Empfehlungstabelle</h2>
<table id="toolTable"></table>
<button class="modal-close-btn" onclick="document.getElementById('modal').style.display='none'">Schlie√üen</button>
</div>
</div>
<script>
fetch('https://api.counterapi.dev/v1/wera-visit/visits/up')
  .then(res => res.json())
  .then(data => {
    const val = data?.count;
    if (val !== undefined) {
      document.getElementById("counter-value").textContent = val;
    }
  })
  .catch(() => {
    // Besucherz√§hler ist optional ‚Äì bei Fehlern still ignorieren
  });
</script>

</div>

</body>
</html>
<!DOCTYPE html>

<html lang="de">
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="icon-192.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
    <link rel="shortcut icon" href="icon-192.png" type="image/png">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Drehmomentkorrektur WERA</title>
<link href="manifest.json" rel="manifest"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="styles.css" rel="stylesheet"/>
</head>
<body class="dark">

<div class="app-shell">

<div class="animated-intro" id="intro">
<div class="animated-logo">
<img alt="Logo" src="icon-192.png"/>
<h2>Drehmomentkorrektur</h2>
<p>Das Tool wird geladen....</p>
</div>
</div>

<main class="container">
  <header class="app-header">
    <div class="brand">
      <img class="brand-logo" src="icon-192.png" alt="WERA" />
      <div class="brand-text">
        <div class="brand-title" id="title">Drehmomentkorrektur WERA</div>
        <div class="brand-subtitle">Tool</div>
      </div>
    </div>

    <div class="toolbar" role="group" aria-label="Aktionen">
      <button id="table-btn" class="btn-ghost" onclick="openTableModal()">ğŸ“‹ Tabelle</button>
      <button id="langBtn" class="btn-ghost" onclick="switchLanguage()">ğŸŒ Sprache: DE</button>
      <button class="btn-ghost" onclick="toggleTheme()">ğŸŒ“ Dark/Light</button>
      <button id="install-btn" class="btn-primary" style="display:block;">ğŸ“² Installieren</button>
      <button class="btn-ghost" id="changelog-btn" onclick="showChangelog()">ğŸ“‹ Changelog</button>
    </div>
  </header>

  <section class="card form-section">
    <div class="field">
      <label for="insertType">Werkzeugeinsatz</label>
      <div class="select">
        <select id="insertType">
<option value="">-- auswÃ¤hlen --</option>
<option value="Joker L">Joker L (14x18)</option>
<option value="Joker XL">Joker XL (14x18)</option>
<option value="Joker XXL">Joker XXL (14x18)</option>
<option value="Joker 3XL">Joker 3XL (14x18)</option>
        </select>
        <span class="chev" aria-hidden="true"></span>
      </div>
    </div>

    <div class="field">
      <label for="sw">SchlÃ¼sselweite</label>
      <div class="select">
        <select disabled="" id="sw">
<option value="">-- zuerst Werkzeugeinsatz wÃ¤hlen --</option>
        </select>
        <span class="chev" aria-hidden="true"></span>
      </div>
    </div>

    <div class="field">
      <label for="keyType">DrehmomentschlÃ¼ssel</label>
      <div class="select">
        <select id="keyType">
<option value="">-- auswÃ¤hlen --</option>
<option value="X4">WERA X4 (40â€“200 Nm)</option>
<option value="X7">WERA X7 (20â€“100 Nm)</option>
        </select>
        <span class="chev" aria-hidden="true"></span>
      </div>
    </div>

    <div class="field">
      <label for="ma">Drehmoment in Nm</label>
      <input id="ma" min="0" type="number" inputmode="decimal" />
    </div>
  </section>

  <section class="card action-section">
    <button class="btn-primary calculate-btn" id="calculate-btn" onclick="calculate()">Jetzt berechnen</button>
    <button class="btn-ghost reset-btn" id="reset-btn" onclick="resetFields()">ZurÃ¼cksetzen</button>
    <div class="loader-bar" id="loader" style="display: none;"></div>
  </section>

  <section class="card result-section" aria-live="polite">
    <span class="result-label">Ergebnis</span>
    <span class="value-chip" id="result">â€“</span>
  </section>

  <section class="card warning-section">
    <div class="warning">
    âš ï¸Achtung<br/>
	Werte auÃŸerhalb der SchlÃ¼sselbereiche kÃ¶nnen zu dauerthaften SchÃ¤den fÃ¼hren!<br/>
    Bitte beachten Sie, dass das Ãœberschreiten der zulÃ¤ssigen Drehmoment- oder SchlÃ¼sselweitenbereiche irreversible SchÃ¤den verursachen kann.<br/>
<br/>
	Da die WerkzeugeinsatzlÃ¤nge, Ausschwenkwinkel bei variabler SchlÃ¼sselweite, sowie der effektive Hebelarm des DrehmomentschlÃ¼ssels, das Messergebnis maÃŸgeblich beeinflussen,<br/>
	ist deshalb eine Korrektur erforderlich.<br/>
<br/>___________________________â—â—â—â—__________________________<br/>
	Die Verwendung dieses Tools erfolgt ausschlieÃŸlich auf eigenes Risiko, und fÃ¼r daraus resultierende SchÃ¤den wird keinerlei Haftung Ã¼bernommen.
	<br/>______________________________________________________________<br/>
    </div>
  </section>

  <footer class="card footer">
    <div class="footer-row">
      <div>Version wird geladenâ€¦</div>
      <div>Erstellt durch Timo Burian</div>
    </div>
    <div class="footer-row footer-small">Â© 2025 â€“ Nutzung nur unter <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noreferrer">CC BY-NC-ND 4.0</a></div>

    <div id="visitor-counter" class="visitor-counter">
      ğŸ‘ï¸ Besuche:<span id="counter-value">â€“</span>
      <div id="counter-debug" class="counter-debug">Debug: Lade BesucherzÃ¤hler...</div>
    </div>
  </footer>

</main>
<div class="modal" id="modalChangelog" onclick="this.style.display='none'">
<div class="modal-content">
<div id="modalChangelogText" style="max-height: 60vh; overflow-y: auto;"></div>
<button class="modal-close-btn" onclick="document.getElementById('modal').style.display='none'">SchlieÃŸen</button></div>
</div>
<script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }

    const sizes = {
      "Joker L": { "16": 44.6, "17": 46.7, "18": 48.2, "19": 49.1 },
      "Joker XL": { "19": 51.6, "20": 53.6, "21": 55.4, "22": 56.7, "23": 56.7, "24": 56.7 },
      "Joker XXL": { "24": 62.2, "27": 68, "30": 70.2, "32": 70.4 },
      "Joker 3XL": { "32": 77, "34": 79, "36": 80, "41": 81.5 }
    };

    const data = {
      X4: { Lk: 435, Sk: 25.5, min: 40, max: 200 },
      X7: { Lk: 343, Sk: 25.5, min: 20, max: 100 }
    };

    document.getElementById("insertType").addEventListener("change", function () {
      const type = this.value;
      const sw = document.getElementById("sw");
      sw.innerHTML = '';
      if (!sizes[type]) {
        sw.disabled = true;
        sw.innerHTML = '<option value="">-- zuerst Werkzeugeinsatz wÃ¤hlen --</option>';
        return;
      }
      sw.disabled = false;
      sw.innerHTML = '<option value="">-- auswÃ¤hlen --</option>';
      Object.keys(sizes[type]).forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = `SW ${val}`;
        sw.appendChild(opt);
      });
    });

    function showModal(txt) {
      document.getElementById("modalText").innerText = txt;
      document.getElementById("modal").style.display = "block";
    }

    function showAddToHome() {
      showModal("ğŸ“² So fÃ¼gst du die App zum Startbildschirm hinzu:\n\nğŸ“± Android: MenÃ¼ > 'Zum Startbildschirm hinzufÃ¼gen'\nğŸ iOS: Teilen-Symbol > 'Zum Homebildschirm'");
    }

    function calculate() {
      const insert = document.getElementById("insertType").value;
      const sw = document.getElementById("sw").value;
      const key = document.getElementById("keyType").value;
      const ma = parseFloat(document.getElementById("ma").value);
      const resultDiv = document.getElementById("result");
      resultDiv.innerText = "";

      if (!insert || !sw || !key || isNaN(ma)) {
        showModal("Bitte fÃ¼lle alle Felder korrekt aus.");
        return;
      }

      const S = sizes[insert][sw];
      const { Sk, Lk, min, max } = data[key];
      const Ms = ma * Lk / (Lk + (S - Sk));
      const rounded = Math.round(Ms * 100) / 100;

      if (rounded < min || rounded > max) {
        showModal(`Das Ergebnis (${rounded} Nm) liegt auÃŸerhalb des Bereichs vom WERA ${key}.`);
      }

      resultDiv.innerText = `korrigierter Wert: ${rounded} Nm`;
    }

    function showChangelog() {
      fetch("https://raw.githubusercontent.com/DtyPnt71/wera-torque/main/README.md")
        .then(response => response.text())
        .then(data => {
          document.getElementById("modalChangelogText").innerHTML = marked.parse(data);
          document.getElementById("modalChangelog").style.display = "block";
        })
        .catch(() => {
          alert("Changelog konnte nicht geladen werden.");
        });
    }
  </script>
<script src="install.js"></script>
<script>
fetch('./version.json')
  .then(res => res.json())
  .then(data => {
    const footer = document.querySelector('footer');
    if (footer) {
      footer.querySelector('div').innerText = 'Version ' + data.version;
    }
  })
  .catch(() => {
    console.warn('Version konnte nicht geladen werden.');
  });
</script>
<script src="script.js"></script>
<div class="modal" id="modal">
<div class="modal-content">
<span class="close" onclick="document.getElementById('modal').style.display='none'">Ã—</span>
<h2>Empfehlungstabelle</h2>
<table id="toolTable"></table>
<button class="modal-close-btn" onclick="document.getElementById('modal').style.display='none'">SchlieÃŸen</button>
</div>
</div>
<script>
fetch('https://api.counterapi.dev/v1/wera-visit/visits/up')
  .then(res => res.json())
  .then(data => {
    console.log("API Response:", data);
    document.getElementById("counter-debug").textContent = "Debug: ZÃ¤hler geladen âœ”ï¸";

    const val = data?.count;
    if (val !== undefined) {
      document.getElementById("counter-value").textContent = val;
    } else {
      document.getElementById("counter-value").textContent = "â€“";
      document.getElementById("counter-debug").textContent = "âš ï¸ Kein Wert in Antwort!";
    }
  })
  .catch(err => {
    console.error("Fetch error:", err);
    document.getElementById("counter-debug").textContent = "Debug: Fehler beim Abruf âŒ";
  });
</script>

</div>

</body>
</html>
